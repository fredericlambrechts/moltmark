generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Agent {
  id          String   @id @default(uuid())
  username    String   @unique
  displayName String?
  description String?
  avatarEmoji String   @default("ðŸ¤–")
  
  // Contact/identity
  ownerHandle String?  // Human owner (e.g., @baloo)
  
  // Certification status
  certificationLevel CertificationLevel @default(UNVERIFIED)
  trustScore         Float              @default(0)
  lastCertifiedAt    DateTime?
  certificationExpires DateTime?
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  capabilities Capability[]
  testResults  TestResult[]
  telemetry    Telemetry[]
  
  @@index([certificationLevel])
  @@index([trustScore])
  @@index([username])
}

model Capability {
  id          String @id @default(uuid())
  agentId     String
  
  // Capability definition
  slug        String // e.g., "typescript-refactor"
  name        String // e.g., "TypeScript Refactoring"
  description String
  
  // Current status
  status      CapabilityStatus @default(DECLARED)
  confidence  Float            @default(0) // 0-100
  
  // Evidence
  testCount   Int @default(0)
  passCount   Int @default(0)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  agent       Agent        @relation(fields: [agentId], references: [id], onDelete: Cascade)
  testResults TestResult[]
  
  @@unique([agentId, slug])
  @@index([agentId])
  @@index([status])
}

model TestResult {
  id            String @id @default(uuid())
  
  // What was tested
  agentId       String
  capabilityId  String
  
  // Test details
  testType      TestType    // CANARY, REGRESSION, CHALLENGE
  status        TestStatus  // PASS, FAIL, ERROR, PENDING
  
  // Results
  score         Float?      // 0-100 quality score
  executionTime Int?        // milliseconds
  costCents     Int?        // cost in cents (API calls, etc.)
  
  // Evidence
  inputHash     String?     // Hash of test input
  outputHash    String?     // Hash of test output
  outputSample  String?     // Truncated output for display
  errorMessage  String?
  
  // Metadata
  runtimeInfo   Json?       // { model, version, tools: [] }
  
  // Timestamps
  createdAt     DateTime @default(now())
  
  // Relations
  agent         Agent       @relation(fields: [agentId], references: [id], onDelete: Cascade)
  capability    Capability  @relation(fields: [capabilityId], references: [id], onDelete: Cascade)
  
  @@index([agentId])
  @@index([capabilityId])
  @@index([createdAt])
  @@index([status])
}

model Telemetry {
  id        String   @id @default(uuid())
  agentId   String
  
  // Event data
  eventType TelemetryEventType
  payload   Json
  
  // Context
  sessionId String?
  timestamp DateTime @default(now())
  
  // Relations
  agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  @@index([agentId])
  @@index([eventType])
  @@index([timestamp])
}

enum CertificationLevel {
  UNVERIFIED      // Just registered, no tests
  PROVISIONAL     // Some tests, < 30 days old
  CERTIFIED       // >95% success, no drift
  DEGRADED        // Drift detected, needs recertification
  REVOKED         // Failed recertification
}

enum CapabilityStatus {
  DECLARED        // Agent claims they can do this
  TESTING         // Currently being evaluated
  VERIFIED        // Passed tests, actively monitored
  FAILED          // Failed tests or drifted
  DEPRECATED      // No longer offered
}

enum TestType {
  CANARY          // Standardized test run continuously
  REGRESSION      // Previous successful task, rerun
  CHALLENGE       // New/difficult task
  ADAPTIVE        // Generated based on weaknesses
}

enum TestStatus {
  PASS
  FAIL
  ERROR
  PENDING
}

enum TelemetryEventType {
  TOOL_CALL
  TOOL_RESULT
  DECISION
  ERROR
  SESSION_START
  SESSION_END
}
